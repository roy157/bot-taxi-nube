/* ==============================================
   C√ìDIGO PARA TU ARCHIVO: index.js
   ¬°VERSI√ìN FINAL (NUBE) CON CIERRE PARA EL PASAJERO!
   ============================================== */

// 1. Importar las librer√≠as
const express = require('express');
const bodyParser = require('body-parser');
const axios = require('axios');

// 2. Configuraci√≥n (Leemos las "llaves" desde el servidor de Render)
const WHATSAPP_TOKEN = process.env.WHATSAPP_TOKEN;
const WHATSAPP_PHONE_ID = process.env.WHATSAPP_PHONE_ID;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN;
const NUMERO_CONDUCTOR_PRUEBA = process.env.NUMERO_CONDUCTOR_PRUEBA;

// 3. Crear el servidor
const app = express();
app.use(bodyParser.json());
const PORT = process.env.PORT || 3000;

// 4. Base de datos temporal (para recordar qui√©n es qui√©n y datos temporales)
let userState = {};

// 5. Funci√≥n de ayuda para enviar mensajes (con botones)
const enviarMensaje = (numero, texto, botones = null) => {
    // Verifica si el n√∫mero es v√°lido antes de enviar
    if (!numero) {
        console.error("Error: Se intent√≥ enviar mensaje a un n√∫mero indefinido. Texto:", texto);
        return; // No intentar enviar si el n√∫mero es inv√°lido
    }
    console.log(`Enviando a ${numero}: ${texto}`);

    let data = {
        messaging_product: 'whatsapp',
        to: numero,
    };

    if (botones) {
        data.type = 'interactive';
        data.interactive = {
            type: 'button',
            body: { text: texto },
            action: {
                buttons: botones.map(btn => ({
                    type: 'reply',
                    reply: { id: btn.id, title: btn.title }
                }))
            }
        };
    } else {
        data.type = 'text';
        data.text = { body: texto };
    }

    axios.post(
        `https://graph.facebook.com/v19.0/${WHATSAPP_PHONE_ID}/messages`,
        data,
        { headers: { 'Authorization': `Bearer ${WHATSAPP_TOKEN}`, 'Content-Type': 'application/json' } }
    ).catch(error => {
        console.error('Error al enviar mensaje de texto/bot√≥n:', error.response ? error.response.data.error.message : error.message);
    });
};

// 6. Funci√≥n de ayuda para enviar UBICACI√ìN
const enviarUbicacion = (numero, lat, long, nombre, direccion) => {
    if (!numero) {
        console.error("Error: Se intent√≥ enviar ubicaci√≥n a un n√∫mero indefinido.");
        return;
    }
    console.log(`Enviando ubicaci√≥n a ${numero}: ${lat},${long}`);

    let data = {
        messaging_product: 'whatsapp',
        to: numero,
        type: 'location',
        location: {
            latitude: lat,
            longitude: long,
            name: nombre,
            address: direccion
        }
    };

    axios.post(
        `https://graph.facebook.com/v19.0/${WHATSAPP_PHONE_ID}/messages`,
        data,
        { headers: { 'Authorization': `Bearer ${WHATSAPP_TOKEN}`, 'Content-Type': 'application/json' } }
    ).catch(error => {
        console.error('Error al enviar ubicaci√≥n:', error.response ? error.response.data.error.message : error.message);
    });
};


// 7. Ruta para que Meta verifique tu Webhook (se usa 1 vez)
app.get('/webhook', (req, res) => {
    if (
        req.query['hub.mode'] === 'subscribe' &&
        req.query['hub.verify_token'] === VERIFY_TOKEN
    ) {
        res.send(req.query['hub.challenge']);
        console.log('¬°Webhook verificado por Meta!');
    } else {
        res.sendStatus(403); // Prohibido
    }
});

// 8. Ruta para RECIBIR los mensajes de WhatsApp (¬°Aqu√≠ est√°n los cambios!)
app.post('/webhook', (req, res) => {

    console.log('Mensaje recibido:', JSON.stringify(req.body, null, 2));
    res.sendStatus(200); // Responder OK a Meta INMEDIATAMENTE

    try {
        if (!req.body.entry || !req.body.entry[0].changes || !req.body.entry[0].changes[0].value.messages || !req.body.entry[0].changes[0].value.messages[0]) {
            console.log("No es un mensaje de usuario (ej. 'read' receipt). Ignorando.");
            return;
        }

        const msg = req.body.entry[0].changes[0].value.messages[0];
        const from = msg.from; // N√∫mero del usuario que env√≠a

        // Inicializamos el estado del usuario si no existe
        if (!userState[from]) {
            userState[from] = { step: 'inicio' };
        }
        let state = userState[from];

        let textoEntrada = '';
        let tipoMensaje = msg.type; // Guardamos el tipo original

        if (tipoMensaje === 'text') {
            textoEntrada = msg.text.body; // Guardamos el texto exacto
        } else if (tipoMensaje === 'interactive' && msg.interactive.type === 'button_reply') {
            textoEntrada = msg.interactive.button_reply.id;
        } else if (tipoMensaje === 'location') {
            textoEntrada = 'location_received';
        }

        console.log(`Procesando entrada [Tipo: ${tipoMensaje}, Texto/ID: "${textoEntrada}"] para el usuario ${from}`);

        // ===============================================
        // El cerebro real empieza aqu√≠
        // ===============================================

        // --- INICIO UNIVERSAL ---
        if (tipoMensaje === 'text' && (state.step === 'inicio' || state.step === 'libre')) {

            if (from === NUMERO_CONDUCTOR_PRUEBA) {
                state.role = 'conductor';
                state.step = 'libre'; // Marcamos al conductor como libre
                enviarMensaje(from, '¬°Hola! üõ∫ Has abierto tu ventana de 24h. Ya est√°s **libre** para recibir servicios.');
            } else {
                state.role = 'pasajero';
                state.step = 'inicio_saludado'; // Cambiamos de 'inicio' para que no vuelva a entrar aqu√≠
                const botones = [
                    { id: 'solicitar_servicio', title: 'Solicitar Servicio' }
                ];
                enviarMensaje(from, '¬°Hola, Muy buen d√≠a! üõ∫\nBienvenido a **Alo Santa Rosa**.\n\nTu servicio de transporte seguro en el distrito Gregorio Albarrac√≠n Lanchipa.', botones);
            }
        }

        // --- L√ìGICA DEL PASAJERO ---
        else if (textoEntrada === 'solicitar_servicio' && state.role === 'pasajero') {
            state.step = 'pidiendo_ubicacion';
            enviarMensaje(from, 'Para poder ofrecerte el mejor servicio, por favor comparte tu ubicaci√≥n. üìç\n(Usa el clip üìé y selecciona Ubicaci√≥n)');
        }

        // El pasajero env√≠a su ubicaci√≥n del MAPA
        else if (textoEntrada === 'location_received' && state.role === 'pasajero' && state.step === 'pidiendo_ubicacion') {
            state.step = 'pidiendo_direccion_escrita';
            state.ubicacionMapa = {
                lat: msg.location.latitude,
                long: msg.location.longitude,
                name: msg.location.name || 'Ubicaci√≥n del Pasajero',
                address: msg.location.address || 'Ver en el mapa'
            };
            enviarMensaje(from, '¬°Ubicaci√≥n del mapa recibida! üëç\nAhora, por favor, escribe tu *direcci√≥n de domicilio completa* (Ej: Calle Ejemplo 123, Referencia: Frente al parque).');
        }

        // El pasajero escribe su direcci√≥n de domicilio
        else if (tipoMensaje === 'text' && state.role === 'pasajero' && state.step === 'pidiendo_direccion_escrita') {
            state.step = 'buscando_conductor';
            state.direccionEscrita = textoEntrada;

            enviarMensaje(from, '¬°Direcci√≥n recibida! Estamos buscando un conductor cercano...');

            if (!NUMERO_CONDUCTOR_PRUEBA) {
                console.log("\n‚ö†Ô∏è ERROR: La variable de entorno 'NUMERO_CONDUCTOR_PRUEBA' no est√° configurada.\n");
                enviarMensaje(from, "Lo siento, no hay conductores de prueba configurados.");
            } else {

                if (userState[NUMERO_CONDUCTOR_PRUEBA] && userState[NUMERO_CONDUCTOR_PRUEBA].step !== 'libre') {
                    console.log("Conductor de prueba ocupado. Estado actual:", userState[NUMERO_CONDUCTOR_PRUEBA].step);
                    enviarMensaje(from, "Lo siento, todos nuestros conductores de prueba est√°n ocupados en este momento. Int√©ntalo m√°s tarde.");
                    state.step = 'inicio'; // Reseteamos al pasajero
                    return; // Salimos de la funci√≥n
                }

                if (!userState[NUMERO_CONDUCTOR_PRUEBA]) userState[NUMERO_CONDUCTOR_PRUEBA] = {};
                userState[NUMERO_CONDUCTOR_PRUEBA].role = 'conductor';
                userState[NUMERO_CONDUCTOR_PRUEBA].step = 'recibiendo_viaje'; // Conductor ahora est√° ocupado
                userState[NUMERO_CONDUCTOR_PRUEBA].pasajeroId = from;

                state.conductorId = NUMERO_CONDUCTOR_PRUEBA;

                enviarMensaje(NUMERO_CONDUCTOR_PRUEBA, '¬°Nueva Solicitud de Servicio! üõ∫');

                const ubiMapa = state.ubicacionMapa;
                enviarUbicacion(NUMERO_CONDUCTOR_PRUEBA, ubiMapa.lat, ubiMapa.long, ubiMapa.name, ubiMapa.address);
                enviarMensaje(NUMERO_CONDUCTOR_PRUEBA, `*Direcci√≥n escrita por el cliente: *\n${state.direccionEscrita}`);

                const botonAceptar = [
                    { id: 'aceptar_servicio', title: 'Aceptar Servicio' }
                ];
                enviarMensaje(NUMERO_CONDUCTOR_PRUEBA, '¬øQuieres aceptar el servicio?', botonAceptar);

                delete state.ubicacionMapa;
                delete state.direccionEscrita;
            }
        }

        // --- L√ìGICA DEL CONDUCTOR ---
        else if (textoEntrada === 'aceptar_servicio' && state.role === 'conductor') {
            state.step = 'aceptado';
            const pasajeroId = state.pasajeroId;

            const infoConductor = {
                nombre: "Hugo Montoya",
                modelo: "Moto Torito Bajaj",
                codigo: "B-48",
                color: "Azul",
                placa: "KZ-2205"
            };

            enviarMensaje(pasajeroId, `¬°Servicio confirmado! üõ∫\n\nSu servicio ser√° prestado por:\n*Nombre:* ${infoConductor.nombre}\n*Veh√≠culo:* ${infoConductor.modelo}\n*Placa:* ${infoConductor.placa}\n\n*Cod. M√≥vil:* ${infoConductor.codigo}\n*Color:* ${infoConductor.color}\n*N√∫mero del conductor es:* ${from}\n\nPor favor, cont√°ctalo solo si es necesario.`);

            if(userState[pasajeroId]) userState[pasajeroId].step = 'conductor_encontrado';

            enviarMensaje(from, `¬°Servicio aceptado! El n√∫mero de tu pasajero es: *${pasajeroId}*.\nPor favor, cont√°ctalo si es necesario.`);

            const botonesTiempo = [
                { id: 'eta_5', title: '0-5 minutos' },
                { id: 'eta_10', title: '5-10 minutos' }
            ];
            enviarMensaje(from, '¬øEn cu√°nto tiempo estimas llegar a la ubicaci√≥n del cliente?', botonesTiempo);
        }

        else if ((textoEntrada === 'eta_5' || textoEntrada === 'eta_10') && state.role === 'conductor' && state.step === 'aceptado') {
             state.step = 'en_viaje'; // Marcamos al conductor como "en viaje"
             const pasajeroId = state.pasajeroId;
             const tiempo = (textoEntrada === 'eta_5') ? '0-5 minutos' : '5-10 minutos';

             enviarMensaje(pasajeroId, `Tu conductor ha confirmado que llegar√° entre ${tiempo}. ¬°Prep√°rate!`);
             // NO reseteamos al pasajero a√∫n, para poder enviarle el mensaje final.

             const botonConcluir = [
                { id: 'concluir_servicio', title: 'Concluir Servicio' }
             ];
             enviarMensaje(from, 'Perfecto. El cliente ha sido notificado.\n\n*Por favor, presiona el bot√≥n de abajo S√ìLO cuando hayas finalizado el viaje.*', botonConcluir);
        }

        // --- CONDUCTOR CONCLUYE EL SERVICIO (¬°MODIFICADO!) ---
        else if (textoEntrada === 'concluir_servicio' && state.role === 'conductor') {
            const pasajeroId = state.pasajeroId; // Recuperamos el ID del pasajero ANTES de resetear

            // 1. Mensaje al Conductor
            enviarMensaje(from, '¬°Servicio concluido! üõ∫\n\n Ya est√°s listo para recibir nuevas solicitudes.');

            // 2. ¬°NUEVO! Mensaje al Pasajero
            if (pasajeroId && userState[pasajeroId]) {
                 enviarMensaje(pasajeroId, '¬°Gracias por confiar en *Alo Santa Rosa*! Esperamos verte pronto. üëã');
                 // Ahora s√≠, reseteamos al pasajero
                 userState[pasajeroId].step = 'inicio';
                 userState[pasajeroId].conductorId = null; // Limpiamos la info del conductor
            } else {
                console.log("No se pudo encontrar al pasajero para enviarle el mensaje de agradecimiento.");
            }

            // 3. Resetear al conductor
            state.step = 'libre'; // ¬°Marcado como libre!
            state.pasajeroId = null; // Olvidamos al pasajero
        }

        else {
            console.log("Comando no reconocido o fuera de flujo:", textoEntrada);
        }

    } catch (error) {
        console.error("Error al procesar el webhook:", error);
    }
});

// 9. Iniciar el servidor (¬°Modo Nube!)
app.listen(PORT, '0.0.0.0', () => {
    console.log(`=======================================================`);
    console.log(`Servidor de Webhook (MODO NUBE 2 JUGADORES) escuchando en el puerto ${PORT}`);
    console.log('¬°Servidor listo y desplegado!');
    console.log(`=======================================================`);
});
